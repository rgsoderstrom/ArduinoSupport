
//
// MessageCodeGenerator.cs - test driver for MessageGen classes
//

using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;

namespace MessageGenerator
{
    internal class MessageCodeGenerator
    {
        const string SyncPattern = "0x1234";

        static void Main (string [] args)
        {
            // what to make this run
            bool MakeCppFiles = true;
            bool MakeCsFiles = false;

            // put generated files here
            string dir = @"C:\Users\rgsod\Documents\Visual Studio 2022\Projects\ArduinoSupport\MessageGenerator\AutoGeneratedFiles\";

            //
            // Describe the message
            //
            string messageNameSpace = "ArduinoInterface"; // only used for C# files
            string messageName = "LoopbackDataMsg";

            // Data section, with strings in C++ syntax
            List<string> dataMembers = new List<string> ()
            {
                "int LBData [WordCount];"
            };

            //*****************************************************************

            if (MakeCppFiles == true)
            {
                try
                {
                    string cppFile = dir + messageName + "_Auto.cpp";

                    using (StreamWriter sw = new StreamWriter (cppFile))
                    {
                        // add file-header comment and standard includes
                        CppCommentAndIncludeFile (sw, messageName);

                        //*********************************************************************

                        // start the default constructor 
                        CppOpenDefaultConstructor (sw, messageName);

                        // close the default ctor with a curly brace
                        CppCloseMethod (sw);

                        //*********************************************************************

                        // start the "from bytes" constructor with memclear and header init
                        CppOpenFromBytesConstructor (sw, messageName);

                        // generate the "from bytes" for each element of Data section
                        CppCpp_FromBytes cppCppFromBytes = new CppCpp_FromBytes (dataMembers);

                        // write those to _Auto.cpp file
                        foreach (string item in cppCppFromBytes.results)
                            sw.WriteLine (item);

                        // close the from-bytes ctor with a curly brace
                        CppCloseMethod (sw);

                        //*********************************************************************

                        // start the ToBytes () method and put in the standard header code
                        CppOpenToBytesMethod (sw, messageName);

                        // generate ToBytes for each dataMembers item
                        CppCpp_ToBytes cppCppToBytes = new CppCpp_ToBytes (dataMembers);
                        foreach (string item in cppCppToBytes.results)
                            sw.WriteLine (item);

                        CppCloseMethod (sw);

                        //*********************************************************************

                    }
                }

                catch (Exception ex)
                {
                    Console.WriteLine ("Exception generating C++ code: " + ex.Message);
                }
            }

            if (MakeCsFiles == true)
            {
                try
                {
                    string csFile = @dir + messageName + "_Auto.cs";

                    using (StreamWriter sw = new StreamWriter (csFile))
                    {
                        CsOpenNamespace (sw, messageNameSpace, messageName);
                        CsOpenClass (sw, messageName);
                        CsOpenConstructor (sw, messageName);
                        CppCs_FromBytes cppCsFromBytes = new CppCs_FromBytes (dataMembers);
                        foreach (string item in cppCsFromBytes.results)
                            sw.WriteLine (item);
                        CsCloseConstructor (sw);

                        CsOpenToBytesMethod (sw, messageName);
                        CppCs_ToBytes cppCsToBytes = new CppCs_ToBytes (dataMembers);
                        foreach (string item in cppCsToBytes.results)
                            sw.WriteLine (item);
                        CsCloseToBytesMethod (sw);
                        CsCloseClass (sw);
                        CsCloseNamespace (sw);
                    }
                }

                catch (Exception ex)
                {
                    Console.WriteLine ("Exception generating C# code: " + ex.Message);
                }
            }
        }

        //
        // Methods to write C++ file
        //
        static void CppCommentAndIncludeFile (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("//");
            sw.WriteLine ("// auto-generated code for message " + msgName);
            sw.WriteLine ("//");
            sw.WriteLine ("");
            sw.WriteLine ("#include <Arduino.h>");
            sw.WriteLine ("#include \"" + msgName + ".h\"");
        }

        static void CppOpenDefaultConstructor (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("");
            sw.WriteLine (msgName + "::" + msgName + " (byte *msgBytes)");
            sw.WriteLine ("{");
            sw.WriteLine ("    memset (this, 0, sizeof (" + msgName + "));");
            sw.WriteLine ("");
            sw.WriteLine ("    header.Sync           = " + SyncPattern + ";");
            sw.WriteLine ("    header.ByteCount      = sizeof (header) + sizeof (data);");
            sw.WriteLine ("    header.MsgId          = " + msgName + "ID;");
            sw.WriteLine ("    header.SequenceNumber = NextSequenceNumber++;");
        }

        static void CppOpenFromBytesConstructor (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("");
            sw.WriteLine (msgName + "::" + msgName + " (byte *msgBytes)");
            sw.WriteLine ("{");
            sw.WriteLine ("    memset (this, 0, sizeof (" + msgName + "));");
            sw.WriteLine ("");
            sw.WriteLine ("    header.Sync           = (msgBytes [1] << 8) | msgBytes [0];");
            sw.WriteLine ("    header.ByteCount      = (msgBytes [3] << 8) | msgBytes [2];");
            sw.WriteLine ("    header.MsgId          = (msgBytes [5] << 8) | msgBytes [4];");
            sw.WriteLine ("    header.SequenceNumber = (msgBytes [7] << 8) | msgBytes [6];");
            sw.WriteLine ("");
            sw.WriteLine ("    int get = 8;");
        }

        static void CppOpenToBytesMethod (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("");
            sw.WriteLine ("void " + msgName + "::ToBytes (byte *byteArray)");
            sw.WriteLine ("{");
            sw.WriteLine ("    int put = 0;");
            sw.WriteLine ("    byteArray [put++] = header.Sync;");
            sw.WriteLine ("    byteArray [put++] = header.Sync >> 8;");
            sw.WriteLine ("    byteArray [put++] = header.ByteCount;");
            sw.WriteLine ("    byteArray [put++] = header.ByteCount >> 8;");
            sw.WriteLine ("    byteArray [put++] = header.MsgId;");
            sw.WriteLine ("    byteArray [put++] = header.MsgId >> 8;");
            sw.WriteLine ("    byteArray [put++] = header.SequenceNumber;");
            sw.WriteLine ("    byteArray [put++] = header.SequenceNumber >> 8;");
        }

        static void CppCloseMethod (StreamWriter sw)
        {
            sw.WriteLine ("}");
        }

        //
        // Methods to write C# file
        //
        static void CsOpenNamespace (StreamWriter sw, string namespaceName, string msgName)
        {
            sw.WriteLine ("//");
            sw.WriteLine ("// auto-generated code for message " + msgName);
            sw.WriteLine ("//");
            sw.WriteLine ("");
            sw.WriteLine ("using System;");
            sw.WriteLine ("using System.Text;");
            sw.WriteLine ("using System.Collections.Generic;");
            sw.WriteLine ("using SocketLib;");
            sw.WriteLine ("");

            sw.WriteLine ("namespace " + namespaceName);
            sw.WriteLine ("{");
        }

        static void CsCloseNamespace (StreamWriter sw)
        {
            sw.WriteLine ("}");
        }

        static void CsOpenClass (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("    public partial class " + msgName);
            sw.WriteLine ("    {");
        }

        static void CsCloseClass (StreamWriter sw)
        {
            sw.WriteLine ("    }");
        }

        static void CsOpenConstructor (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("        public " + msgName + " (byte [] fromBytes)");
            sw.WriteLine ("        {");
            sw.WriteLine ("            header = new Header ();");
            sw.WriteLine ("            data = new Data ();");
            sw.WriteLine ("            int byteIndex = 0;");
            sw.WriteLine ("");
            sw.WriteLine ("            header.Sync           = BitConverter.ToUInt16 (fromBytes, byteIndex); byteIndex += 2;");
            sw.WriteLine ("            header.ByteCount      = BitConverter.ToUInt16 (fromBytes, byteIndex); byteIndex += 2;");
            sw.WriteLine ("            header.MessageId      = BitConverter.ToUInt16 (fromBytes, byteIndex); byteIndex += 2;");
            sw.WriteLine ("            header.SequenceNumber = BitConverter.ToUInt16 (fromBytes, byteIndex); byteIndex += 2;");
        }

        static void CsCloseConstructor (StreamWriter sw)
        {
            sw.WriteLine ("        }");
        }

        static void CsOpenToBytesMethod (StreamWriter sw, string msgName)
        {
            sw.WriteLine ("");
            sw.WriteLine ("        public byte[] ToBytes ()");
            sw.WriteLine ("        {");
            sw.WriteLine ("            List<byte> byteList = new List<byte> ();");
            sw.WriteLine ("");
            sw.WriteLine ("            byteList.InsertRange (byteList.Count, BitConverter.GetBytes (header.Sync));");
            sw.WriteLine ("            byteList.InsertRange (byteList.Count, BitConverter.GetBytes (header.ByteCount));");
            sw.WriteLine ("            byteList.InsertRange (byteList.Count, BitConverter.GetBytes (header.MessageId));");
            sw.WriteLine ("            byteList.InsertRange (byteList.Count, BitConverter.GetBytes (header.SequenceNumber));");
        }

        static void CsCloseToBytesMethod (StreamWriter sw)
        {
            sw.WriteLine ("");
            sw.WriteLine ("            // append data bytes to header bytes");
            sw.WriteLine ("            byte[] msgBytes = new byte [byteList.Count];");
            sw.WriteLine ("            byteList.CopyTo (msgBytes, 0);");
            sw.WriteLine ("            return msgBytes;");
            sw.WriteLine ("        }");
        }
    }
}



